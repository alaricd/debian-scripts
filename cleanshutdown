#!/usr/bin/env bash
set -Eeuo pipefail
IFS=$'\n\t'

# Determine the directory containing this script so sibling helpers are invoked
# correctly even when cleanshutdown is run from another location.
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

if [[ $EUID -ne 0 && "${CLEANSHUTDOWN_ALLOW_NONROOT:-0}" != "1" ]]; then
  echo "cleanshutdown must run as root" >&2
  exit 1
fi

sync
"${SCRIPT_DIR}/check-if-already-updating.sh"
NO_REBOOT=1 "${SCRIPT_DIR}/autoupdate-and-reboot.sh"

sudo -u "${SUDO_USER:-$USER}" bleachbit -c --preset || true
bleachbit -c --preset || true

shutdown -h now
