#!/usr/bin/env bash
set -Eeuo pipefail
IFS=$'\n\t'

# Determine the directory containing this script so sibling helpers are invoked
# correctly even when cleanshutdown is run from another location.
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

sync && \
"${SCRIPT_DIR}/check-if-already-updating.sh" && \
"${SCRIPT_DIR}/remove-old-kernels.sh" && \
"${SCRIPT_DIR}/remove-all-old-packages.sh" && \
"${SCRIPT_DIR}/remove-old-snaps.sh" && \
"${SCRIPT_DIR}/autoupdate.sh"

# BleachBit often fails on stale profiles; ignore those errors so shutdown proceeds.
sudo -u "${USER}" /usr/bin/bleachbit -c --preset || true
/usr/bin/bleachbit -c --preset || true

shutdown -h now
